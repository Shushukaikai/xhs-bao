<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>8-K 重大事项雷达（页面内刷新 · 不发邮件）</title>
<style>
  :root{--accent:#ff3b30;--muted:#666;font-family:"PingFang SC","Helvetica Neue","Microsoft Yahei",Arial}
  body{margin:0;background:linear-gradient(180deg,#f7f7f9,#fff);color:#111}
  .wrap{max-width:1100px;margin:0 auto;padding:18px 16px 40px}
  header{display:flex;gap:12px;align-items:center;margin-bottom:12px}
  header h1{margin:0;font-size:20px} .muted{color:var(--muted);font-size:12px;margin:4px 0 0}
  .card{background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);padding:14px;margin-top:14px}
  label{display:block;margin-top:8px;font-size:13px}
  input,select{width:100%;padding:8px 10px;margin-top:6px;border:1px solid #e8e8ef;border-radius:8px;font-size:14px}
  .row{display:flex;gap:8px;align-items:flex-end;flex-wrap:wrap}
  .btn{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:9px 14px;font-weight:700;cursor:pointer}
  .btn.secondary{background:#fff;color:#222;border:1px solid #eee}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .item{border:1px solid #efeff4;border-radius:10px;padding:12px}
  .badge{display:inline-block;background:#f5f5ff;border:1px solid #eee;border-radius:999px;padding:4px 8px;margin:4px 6px 0 0;font-size:12px}
  .copy{white-space:pre-wrap;background:linear-gradient(180deg,#fff,#fbfbfb);border:1px solid #efeff4;border-radius:10px;min-height:120px;padding:10px;margin-top:8px}
  .tag{display:inline-block;background:#fafafa;border:1px solid #eee;border-radius:999px;padding:3px 8px;margin-right:6px;font-size:12px}
  .line{height:1px;background:#f0f0f3;margin:10px 0}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <img alt="logo" width="48" height="48" style="border-radius:12px;box-shadow:0 6px 14px rgba(0,0,0,.08)"
      src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='96' height='96'><rect width='96' height='96' rx='16' fill='%23ff3b30'/><text x='50%' y='55%' text-anchor='middle' font-size='48' fill='white' font-family='Arial'>8K</text></svg>">
    <div>
      <h1>8-K 重大事项雷达（页面内刷新显示最新）</h1>
      <p class="muted">输入自选股，点击“立即刷新”，下方直接显示近 N 天（默认 1 天）最新 8-K 摘要与原文链接。</p>
    </div>
  </header>

  <div class="card">
    <div class="row">
      <label style="flex:2">自选股（逗号分隔）：
        <input id="watch" placeholder="AAPL,TSLA,NVDA" value="AAPL,TSLA,NVDA">
      </label>
      <label style="flex:1">时间窗口（天，1–7）：
        <input id="days" type="number" min="1" max="7" value="1">
      </label>
      <button class="btn" id="refresh">立即刷新</button>
      <button class="btn secondary" id="save">保存自选</button>
    </div>
    <p class="muted" id="status">未刷新</p>
  </div>

  <div id="board" class="grid"></div>
</div>

<script>
function loadWatch() {
  const w = localStorage.getItem("x8k_watch") || "AAPL,TSLA,NVDA";
  document.getElementById("watch").value = w;
}
function saveWatch() {
  const v = document.getElementById("watch").value.trim();
  localStorage.setItem("x8k_watch", v);
  document.getElementById("status").textContent = "自选已保存：" + v;
}
function fmt(n){ return Number(n).toLocaleString("en-US"); }

async function query() {
  const status = document.getElementById("status");
  const board = document.getElementById("board");
  board.innerHTML = "";
  const watch = document.getElementById("watch").value.trim();
  const days = Math.min(7, Math.max(1, parseInt(document.getElementById("days").value || "1", 10)));
  if (!watch) { status.textContent = "请输入自选股"; return; }

  status.textContent = "查询中…";
  try {
    const url = `/api/eightk?symbol=${encodeURIComponent(watch)}&days=${days}`;
    const res = await fetch(url);
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || "API Error");

    status.textContent = "更新时间：" + new Date(data.updatedAt).toLocaleString();

    // 把所有结果拍平到卡片
    const cards = [];
    for (const r of data.results) {
      if (!r.ok || r.count === 0) continue;
      for (const f of r.filings) {
        const importantScore = (f.items || []).reduce((acc, it) => {
          // 给几个常见重要条款更高分；仅用于排序
          if (/^2\.02|^2\.03|^5\.02|^5\.07|^8\.01/.test(it.code)) return acc + 3;
          return acc + 1;
        }, 0);
        cards.push({ symbol: r.symbol, filingDate: f.filingDate, items: f.items, docUrl: f.docUrl, summary: f.summary, score: importantScore });
      }
    }

    // 按重要度+日期排序
    cards.sort((a,b)=>{
      if (b.filingDate !== a.filingDate) return b.filingDate.localeCompare(a.filingDate);
      return (b.score||0)-(a.score||0);
    });

    if (cards.length === 0) {
      board.innerHTML = `<div class="card">近 ${days} 天内自选股暂无 8-K 更新。</div>`;
      return;
    }

    // 渲染卡片
    for (const c of cards) {
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>${c.symbol}</strong> · <span class="muted">${c.filingDate}</span></div>
          <a href="${c.docUrl}" target="_blank" class="muted">查看原文</a>
        </div>
        <div class="line"></div>
        <div>${(c.items||[]).map(it=>`<span class="badge">Item ${it.code} · ${it.label}</span>`).join("") || '<span class="badge">未识别到典型条款</span>'}</div>
        <div class="copy" id="cp_${c.symbol}_${c.filingDate.replace(/-/g,"")}">${c.summary.body.replaceAll("&","&amp;")}</div>
        <div style="margin-top:8px">
          <button class="btn secondary" onclick="copyText('cp_${c.symbol}_${c.filingDate.replace(/-/g,"")}')">复制小红书文案</button>
        </div>
      `;
      board.appendChild(el);
    }
  } catch (e) {
    status.textContent = "查询失败：" + e.message;
  }
}

function copyText(id){
  const el = document.getElementById(id);
  const txt = el.innerText || el.textContent || "";
  navigator.clipboard.writeText(txt).then(()=> {
    alert("已复制，可直接去小红书/公众号粘贴发布");
  });
}

document.getElementById("refresh").addEventListener("click", query);
document.getElementById("save").addEventListener("click", saveWatch);
loadWatch(); // 初始化自选
query();     // 打开即拉一次
</script>
</body>
</html>
